name: "[Tests] ERC7730 Nightly"
on:
  schedule:
    # Run every day at 2:00 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      device:
        description: "Device to test"
        required: false
        default: "stax"
        type: choice
        options:
          - stax
          - nanox
          - nanos+
          - flex
      provider:
        description: "Provider to test (leave empty for all)"
        required: false
        default: ""
        type: string

env:
  FORCE_COLOR: "1"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: Setup toolchain and dependencies
    runs-on: ledgerhq-device-sdk
    steps:
      - uses: actions/checkout@v6

      - uses: LedgerHQ/device-sdk-ts/.github/actions/setup-with-cache-composite@develop

  build-libraries:
    name: Build libraries
    needs: [setup]
    runs-on: ledgerhq-device-sdk
    steps:
      - uses: actions/checkout@v6

      - uses: LedgerHQ/device-sdk-ts/.github/actions/setup-with-build-cache-composite@develop

  erc7730-tests:
    name: ERC7730 (${{ matrix.device }} - ${{ matrix.provider }}${{ matrix.chain && format(' {0}', matrix.chain) || '' }})
    needs: [build-libraries]
    runs-on: ledgerhq-device-sdk
    strategy:
      fail-fast: false
      matrix:
        device:
          - stax
          - nanox
          - nanos+
          - flex
        include_provider:
          - provider: "1inch"
            chain: ""
          - provider: "1inch"
            chain: "arbitrum"
          - provider: "aave"
            chain: ""
          - provider: "ethena"
            chain: ""
          - provider: "lido"
            chain: ""
          - provider: "lombard"
            chain: ""
          - provider: "poap"
            chain: ""
          - provider: "swissborg"
            chain: ""
          - provider: "tether"
            chain: ""
          - provider: "uniswap"
            chain: ""
          - provider: "velora"
            chain: ""
          - provider: "yieldxyz"
            chain: ""
    steps:
      - uses: actions/checkout@v6

      - uses: LedgerHQ/device-sdk-ts/.github/actions/setup-with-build-cache-composite@develop

      - name: Generate token
        id: generate-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_BOT_APP_ID }}
          private_key: ${{ secrets.GH_BOT_PRIVATE_KEY }}

      - name: Retrieving coin apps
        uses: actions/checkout@v6
        with:
          ref: master
          repository: LedgerHQ/coin-apps
          token: ${{ steps.generate-token.outputs.token }}
          path: coin-apps
          sparse-checkout: |
            ${{ matrix.device }}/*/Ethereum/*.elf
          sparse-checkout-cone-mode: false

      - name: Pull Speculos Docker image
        run: docker pull ghcr.io/ledgerhq/speculos

      - name: Run ERC7730 Test
        id: erc7730-test
        env:
          GATING_TOKEN: ${{ secrets.GATING_TOKEN }}
          COIN_APPS_PATH: "${{ github.workspace }}/coin-apps"
        run: |
          mkdir -p /tmp/logs/screenshots
          pnpm cs-tester test:erc7730 ${{ matrix.include_provider.provider }} ${{ matrix.include_provider.chain }} \
            --device ${{ matrix.device }} \
            --log-level error \
            --log-file "/tmp/logs/erc7730-${{ matrix.include_provider.provider }}-${{ matrix.include_provider.chain }}.log" \
            --file-log-level debug \
            --screenshot-folder-path "/tmp/logs/screenshots"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: erc7730-logs-${{ matrix.device }}-${{ matrix.include_provider.provider }}${{ matrix.include_provider.chain && format('-{0}', matrix.include_provider.chain) || '' }}
          path: /tmp/logs/
          retention-days: 7
